<% layout("/layouts/boilerplate.ejs") %>

<style>
  .filters{
    position: sticky;
    top: 56px; 
    z-index: 10;
    cursor: pointer;
  }
  .filter-card { box-shadow: 0 1px 8px rgba(0,0,0,.04); }
</style>

<body>
  <!-- Filters -->
  <div class="container filters">
    <form class="mb-3 p-3 rounded border bg-light filter-card" method="GET" action="/listings">
      <div class="row g-3 align-items-end">
        <!-- Price -->
        <div class="col-12 col-md-3">
          <label class="form-label fw-semibold">Price Range</label>
          <select class="form-select" name="price">
            <option value=""     <%= !query.price ? 'selected' : '' %>>Any</option>
            <option value="lt4000" <%= query.price==='lt4000'?'selected':'' %>>&lt; ₹1000</option>
            <option value="4to6"   <%= query.price==='4to6' ?'selected':'' %>>₹1000–₹2000</option>
            <option value="6to8"   <%= query.price==='6to8' ?'selected':'' %>>₹2000–₹4000</option>
            <option value="gt8000" <%= query.price==='gt8000'?'selected':'' %>>₹4000+</option>
          </select>
        </div>


        <!-- Distance -->
        <div class="col-12 col-md-3">
          <label class="form-label fw-semibold">Distance from Campus</label>
          <select class="form-select" name="distance">
            <option value=""      <%= !query.distance?'selected':'' %>>Any</option>
            <option value="lt500" <%= query.distance==='lt500'?'selected':'' %>>&lt; 500 m</option>
            <option value="0_1"   <%= query.distance==='0_1'  ?'selected':'' %>>0.5 – 1 km</option>
            <option value="1_3"   <%= query.distance==='1_3'  ?'selected':'' %>>1 – 3 km</option>
            <option value="gt3"   <%= query.distance==='gt3'  ?'selected':'' %>>&gt; 3 km</option>
          </select>
        </div>

        <!-- Amenities (chip-style toggles) -->
        <div class="col-12 col-md-4">
          <label class="form-label fw-semibold d-block">Amenities</label>
          <% const am = (Array.isArray(query.amenities) ? query.amenities : (query.amenities ? [query.amenities] : [])); %>
          <div class="btn-group flex-wrap" role="group" aria-label="Amenities">
            <% const amenityOptions = ['WiFi','Laundry','Meals','Air conditioning','Free Breakfast','Parking']; %>
            <% amenityOptions.forEach((a,i)=>{ %>
              <input type="checkbox" class="btn-check" id="am<%=i%>" name="amenities[]" value="<%=a%>" <%= am.includes(a)?'checked':'' %> autocomplete="off">
              <label class="btn btn-outline-secondary me-2 mb-2" for="am<%=i%>"><%= a %></label>
            <% }) %>
          </div>
        </div>

        <!-- Actions -->
        <div class="col-12 text-end">
          <button class="btn btn-danger me-2" type="submit">Apply</button>
          <a class="btn btn-outline-secondary" href="/listings">Clear</a>
        </div>
      </div>
    </form>
  </div>

  <!-- Cards -->
  <div class="container">
    <div class="row row-cols-lg-3 row-cols-md-2 row-cols-1 g-3">
      <% for (let listing of allistings) { %>
        <div class="col">
          <a href="/listings/<%= listing._id %>" class="text-decoration-none text-dark">
            <div class="card h-100">
              <img
                src="<%= listing.image && listing.image.url ? listing.image.url : 'https://placehold.co/800x500?text=No+Image' %>"
                class="card-img-top"
                alt="listing_image"
                style="height: 20rem; object-fit: cover;"
                loading="lazy"
              >
              <div class="card-body mt-2 p-2 md-2">
                <p class="card-text mb-1 fw-semibold text-truncate"><%= listing.title %></p>
                <small>₹<%= listing.price.toLocaleString("en-IN") %>/night</small>

                <% if (listing.amenities && listing.amenities.length) { %>
                  <div class="mt-2 d-flex flex-wrap gap-2">
                    <% listing.amenities.slice(0,4).forEach(a => { %>
                      <span class="badge rounded-pill text-bg-primary"><%= a %></span>
                    <% }) %>
                    <% if (listing.amenities.length > 4) { %>
                      <span class="badge rounded-pill text-bg-light">+<%= listing.amenities.length - 4 %></span>
                    <% } %>
                  </div>
                <% } %>
              </div>
            </div>
          </a>
        </div>
      <% } %>
    </div>
  </div>
</body>
